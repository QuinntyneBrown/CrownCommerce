<div class="chat-shell">
  <!-- Channel List -->
  @if (!isMobile() || showChannelList()) {
    <aside class="channel-list">
      <div class="channel-header">
        <h2 class="channel-header-title">Messages</h2>
        <button mat-icon-button (click)="openNewChannelDialog()"><mat-icon>edit_square</mat-icon></button>
      </div>

      <!-- Search -->
      <div class="channel-search">
        <mat-icon class="search-icon">search</mat-icon>
        <input class="search-input"
               placeholder="Search conversations..."
               [value]="searchQuery()"
               (input)="onSearchInput($event)" />
        @if (searchQuery()) {
          <button mat-icon-button class="search-clear" (click)="clearSearch()">
            <mat-icon>close</mat-icon>
          </button>
        }
      </div>

      <!-- Channels Section -->
      <div class="channel-section">
        <span class="channel-section-label">Channels</span>
        @for (channel of publicChannels(); track channel.id) {
          <div class="channel-item"
               [class.channel-item--active]="channel.id === selectedChannelId()"
               (click)="selectChannel(channel.id)">
            <mat-icon class="channel-icon">{{ channel.icon }}</mat-icon>
            <span class="channel-name"># {{ channel.name }}</span>
            @if (channel.unreadCount > 0) {
              <span class="unread-badge">{{ channel.unreadCount }}</span>
            }
          </div>
        }
      </div>

      <!-- Direct Messages Section -->
      <div class="channel-section">
        <span class="channel-section-label">Direct Messages</span>
        @for (dm of directMessages(); track dm.id) {
          <div class="channel-item"
               [class.channel-item--active]="dm.id === selectedChannelId()"
               (click)="selectChannel(dm.id)">
            <div class="dm-avatar">{{ dm.name[0] }}</div>
            <span class="channel-name">{{ dm.name }}</span>
            @if (dm.unreadCount > 0) {
              <span class="unread-badge">{{ dm.unreadCount }}</span>
            }
          </div>
        }
      </div>
    </aside>
  }

  <!-- Message Thread -->
  @if (!isMobile() || !showChannelList()) {
    <div class="message-thread">
      <!-- Thread Header -->
      <div class="thread-header">
        @if (isMobile()) {
          <button mat-icon-button (click)="backToChannels()">
            <mat-icon>arrow_back</mat-icon>
          </button>
        }
        <div class="thread-info">
          <span class="thread-name">
            @if (selectedChannel(); as ch) {
              @if (ch.isPrivate) {
                {{ ch.name }}
              } @else {
                # {{ ch.name }}
              }
            }
          </span>
        </div>
        <div class="thread-actions">
          <button mat-icon-button (click)="startVideoCall()" [disabled]="!selectedChannel()">
            <mat-icon>videocam</mat-icon>
          </button>
          <button mat-icon-button (click)="startAudioCall()" [disabled]="!selectedChannel()">
            <mat-icon>call</mat-icon>
          </button>
          <button mat-icon-button><mat-icon>more_vert</mat-icon></button>
        </div>
      </div>

      <!-- Messages -->
      <div class="messages-area">
        @if (hasMoreMessages() && !searchResults().length) {
          <div class="load-more-bar">
            <button class="load-more-btn" (click)="loadMoreMessages()" [disabled]="isLoadingMore()">
              @if (isLoadingMore()) {
                Loading...
              } @else {
                Load older messages
              }
            </button>
          </div>
        }
        @if (searchResults().length > 0) {
          <div class="search-results-header">
            <mat-icon>search</mat-icon>
            <span>{{ searchResults().length }} result{{ searchResults().length === 1 ? '' : 's' }} found</span>
            <button mat-icon-button (click)="clearSearch()"><mat-icon>close</mat-icon></button>
          </div>
          @for (msg of searchResults(); track msg.id) {
            <div class="message">
              <div class="message-avatar">{{ msg.senderInitials }}</div>
              <div class="message-bubble">
                <span class="message-sender">{{ msg.senderName }}</span>
                <p class="message-text" [innerHTML]="msg.content | mentionHighlight"></p>
                <span class="message-time">{{ msg.timestamp }}</span>
              </div>
            </div>
          }
        } @else {
          @for (msg of messages(); track msg.id) {
            <div class="message" [class.message--own]="msg.isOwn">
              @if (!msg.isOwn) {
                <div class="message-avatar">{{ msg.senderInitials }}</div>
              }
              <div class="message-bubble">
                @if (!msg.isOwn) {
                  <span class="message-sender">{{ msg.senderName }}</span>
                }
                @if (editingMessageId() === msg.id) {
                  <div class="edit-inline">
                    <input class="edit-input"
                           [value]="editText()"
                           (input)="editText.set($any($event.target).value)"
                           (keydown.enter)="saveEdit(msg)"
                           (keydown.escape)="cancelEdit()" />
                    <div class="edit-actions">
                      <button mat-icon-button class="edit-save" (click)="saveEdit(msg)">
                        <mat-icon>check</mat-icon>
                      </button>
                      <button mat-icon-button class="edit-cancel" (click)="cancelEdit()">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  </div>
                } @else {
                  <p class="message-text" [innerHTML]="msg.content | mentionHighlight"></p>
                }
                @if (msg.attachments && msg.attachments.length > 0) {
                  <div class="attachments-list">
                    @for (att of msg.attachments; track att.id) {
                      @if (isImageFile(att.contentType)) {
                        <a class="attachment-image-link" [href]="att.url" target="_blank">
                          <img class="attachment-image" [src]="att.url" [alt]="att.fileName" />
                        </a>
                      } @else {
                        <a class="attachment-file" [href]="att.url" target="_blank" download>
                          <mat-icon class="attachment-icon">insert_drive_file</mat-icon>
                          <div class="attachment-info">
                            <span class="attachment-name">{{ att.fileName }}</span>
                            <span class="attachment-size">{{ formatFileSize(att.sizeBytes) }}</span>
                          </div>
                          <mat-icon class="attachment-download">download</mat-icon>
                        </a>
                      }
                    }
                  </div>
                }
                <span class="message-time">{{ msg.timestamp }}</span>
                @if (msg.reactions && msg.reactions.length > 0) {
                  <div class="reactions-bar">
                    @for (reaction of msg.reactions; track reaction.emoji) {
                      <button class="reaction-chip" [class.reaction-chip--active]="reaction.hasReacted"
                              (click)="toggleReaction(msg, reaction.emoji)">
                        {{ reaction.emoji }} {{ reaction.count }}
                      </button>
                    }
                  </div>
                }
              </div>
              <div class="msg-actions-col">
                @if (editingMessageId() !== msg.id) {
                  <button mat-icon-button class="msg-menu-btn" [matMenuTriggerFor]="emojiMenu">
                    <mat-icon>add_reaction</mat-icon>
                  </button>
                  <mat-menu #emojiMenu="matMenu">
                    <div class="emoji-picker" (click)="$event.stopPropagation()">
                      @for (emoji of quickEmojis; track emoji) {
                        <button class="emoji-btn" (click)="toggleReaction(msg, emoji)">{{ emoji }}</button>
                      }
                    </div>
                  </mat-menu>
                }
                @if (msg.isOwn && editingMessageId() !== msg.id) {
                  <button mat-icon-button class="msg-menu-btn" [matMenuTriggerFor]="msgMenu">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #msgMenu="matMenu">
                    <button mat-menu-item (click)="startEdit(msg)">
                      <mat-icon>edit</mat-icon>
                      <span>Edit</span>
                    </button>
                    <button mat-menu-item (click)="deleteMessage(msg)">
                      <mat-icon>delete</mat-icon>
                      <span>Delete</span>
                    </button>
                  </mat-menu>
                }
              </div>
            </div>
          }
        }
      </div>

      <!-- Typing Indicator -->
      @if (typingUsers().length > 0) {
        <div class="typing-indicator">
          <span class="typing-dots">
            <span></span><span></span><span></span>
          </span>
          @if (typingUsers().length === 1) {
            <span>{{ typingUsers()[0] }} is typing...</span>
          } @else if (typingUsers().length === 2) {
            <span>{{ typingUsers()[0] }} and {{ typingUsers()[1] }} are typing...</span>
          } @else {
            <span>Several people are typing...</span>
          }
        </div>
      }

      <!-- Mention Dropdown -->
      @if (showMentionDropdown() && mentionSuggestions().length > 0) {
        <div class="mention-dropdown">
          @for (name of mentionSuggestions(); track name) {
            <button class="mention-item" (mousedown)="selectMention(name)">
              <div class="mention-avatar">{{ name[0] }}</div>
              <span>{{ name }}</span>
            </button>
          }
        </div>
      }

      <!-- Pending Attachments -->
      @if (pendingAttachments().length > 0) {
        <div class="pending-attachments">
          @for (att of pendingAttachments(); track att.id) {
            <div class="pending-chip">
              @if (isImageFile(att.contentType)) {
                <img class="pending-thumb" [src]="att.url" [alt]="att.fileName" />
              } @else {
                <mat-icon class="pending-file-icon">insert_drive_file</mat-icon>
              }
              <span class="pending-name">{{ att.fileName }}</span>
              <button mat-icon-button class="pending-remove" (click)="removePendingAttachment(att.id)">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          }
        </div>
      }

      <!-- Input Bar -->
      <div class="input-bar">
        <button mat-icon-button class="attach-btn" (click)="triggerFileInput()" [disabled]="isUploading()">
          <mat-icon>attach_file</mat-icon>
        </button>
        <input class="message-input"
               placeholder="Type a message..."
               [value]="messageText()"
               (input)="onMessageInput($event)"
               (keydown.enter)="sendMessage()" />
        <button mat-icon-button class="send-btn"
                [disabled]="!messageText().trim() && pendingAttachments().length === 0"
                (click)="sendMessage()">
          <mat-icon>send</mat-icon>
        </button>
      </div>
    </div>
  }
</div>
