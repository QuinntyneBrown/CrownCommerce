# cc db — Database Operations

> **Rank**: #3 (High)
> **Effort**: Medium (2 weeks)
> **Dependencies**: SqlPackage, EF Core Tools

## The Problem

With 11 separate databases across local (LocalDB), staging (Azure SQL), and production (Azure SQL), developers constantly need to:

- See what data exists in production when debugging issues
- Clone production data locally to reproduce a bug (without exposing PII)
- Compare schemas to find drift between environments
- Reset local databases quickly after a bad experiment
- Get connection strings without digging through multiple appsettings files

## Key Commands

### `cc db pull` — Clone a Remote Database Locally

Pulls a database from any environment to your local machine. Production pulls are anonymized by default.

```bash
# Pull production catalog data (anonymized)
cc db pull catalog --env production
# Downloading CrownCommerce_Catalog from crowncommerce.database.windows.net...
# Anonymizing 0 tables (catalog has no PII)...
# Restoring to (localdb)\MSSQLLocalDB\CrownCommerce_Catalog...
# Done. 12 products, 5 origins restored.

# Pull production CRM data (PII anonymized automatically)
cc db pull crm --env production
# Downloading CrownCommerce_Crm from crowncommerce.database.windows.net...
# Anonymizing 1 table:
#   Contacts: Email (hash), FirstName (fake), LastName (fake), Phone (mask)
# Restoring to (localdb)\MSSQLLocalDB\CrownCommerce_Crm...
# Done. 847 contacts, 2,341 interactions restored.
```

### `cc db diff` — Compare Schemas Between Environments

Catches schema drift before it causes production errors:

```bash
$ cc db diff catalog --from development --to production

Schema Diff: CrownCommerce_Catalog
══════════════════════════════════════

  + Column: HairProducts.Weight (decimal(18,2), nullable)   [development only]
  + Index: IX_HairProducts_OriginId_Type                    [development only]
  - Column: HairProducts.LegacySku (nvarchar(50))           [production only]

  Action needed:
  Run 'cc migrate apply catalog --env production' to sync schemas.
```

### `cc db reset` — Clean Slate for Local Development

Drops the database, recreates it with current migrations, and runs the seeder:

```bash
$ cc db reset catalog
# Dropping CrownCommerce_Catalog on (localdb)\MSSQLLocalDB...
# Running migrations (3 migrations)...
# Running CatalogDbSeeder...
# Done. Database reset with 12 products, 5 origins.

$ cc db reset all
# Resetting all 11 databases...
# [1/11] catalog    OK (12 products, 5 origins)
# [2/11] chat       OK (empty)
# [3/11] content    OK (5 pages, 8 gallery, 6 FAQs, 3 testimonials)
# ...
# [11/11] scheduling OK (5 employees, 4 meetings, 7 channels)
# All 11 databases reset successfully.
```

### `cc db connection` — Quick Connection String Lookup

No more digging through appsettings files:

```bash
$ cc db connection catalog
Server=(localdb)\MSSQLLocalDB;Database=CrownCommerce_Catalog;Trusted_Connection=True;TrustServerCertificate=True;

$ cc db connection catalog --env production
Server=tcp:crowncommerce.database.windows.net,1433;Initial Catalog=CrownCommerce_Catalog;...

$ cc db connection all
catalog      (localdb)\MSSQLLocalDB  CrownCommerce_Catalog
chat         (localdb)\MSSQLLocalDB  CrownCommerce_Chat
content      (localdb)\MSSQLLocalDB  CrownCommerce_Content
crm          (localdb)\MSSQLLocalDB  CrownCommerce_Crm
identity     (localdb)\MSSQLLocalDB  CrownCommerce_Identity
inquiry      (localdb)\MSSQLLocalDB  CrownCommerce_Inquiry
newsletter   (localdb)\MSSQLLocalDB  CrownCommerce_Newsletter
notification (localdb)\MSSQLLocalDB  CrownCommerce_Notification
order        (localdb)\MSSQLLocalDB  CrownCommerce_Order
payment      (localdb)\MSSQLLocalDB  CrownCommerce_Payment
scheduling   (localdb)\MSSQLLocalDB  CrownCommerce_Scheduling
```

## Anonymization Strategy

The anonymization config protects PII while preserving data relationships and realistic distributions:

| Strategy | Behavior | Example |
|----------|----------|---------|
| `hash` | SHA256 of original value + salt | `quinn@cc.com` → `a8f3...@anon.local` |
| `fake:firstName` | Bogus library fake data | `Quinn` → `Alejandro` |
| `fake:lastName` | Bogus library fake data | `Brown` → `Nakamura` |
| `mask` | Preserve format, replace chars | `416-555-1234` → `***-***-1234` |
| `null` | Set to NULL | `$2b$10$hash...` → `NULL` |
| `preserve` | Keep original (non-PII) | Product names, prices |

Foreign key relationships are preserved — if Contact #42 had 15 interactions, the anonymized version still has 15 interactions linked to (anonymized) Contact #42.
